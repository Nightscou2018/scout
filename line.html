<!doctype html>
<html>

<head>
	<title>Line Chart</title>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
	<script src="http://www.chartjs.org/dist/2.7.1/Chart.js"></script>
	<script src="http://www.chartjs.org/samples/latest/utils.js"></script>
	<script src="chartjs-plugin-annotation.min.js"></script>
	<script src="http://smalljs.org/ajax/superagent/superagent.js"></script>
	<style>
    canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
    }
	</style>
</head>

<body>
	<div style="width:75%;">
		<canvas id="canvas"></canvas>
	</div>
	<br>
	<br>
	<button id="randomizeData">Randomize Data</button>
	<button id="addDataset">Add Dataset</button>
	<button id="removeDataset">Remove Dataset</button>
	<button id="addData">Add Data</button>
	<button id="removeData">Remove Data</button>
	<script>

		var timeFormat = 'MM/DD/YYYY HH:mm';


		function newDate(days) {
			return moment().add(days, 'd').toDate();
		}

		function newDateString(days) {
			return moment().add(days, 'd').format(timeFormat);
		}

		function newTimestamp(days) {
			return moment().add(days, 'd').unix();
		}

		function colorForSgv(sgv) {
			if (sgv < 80) return 'rgb(255, 0, 0)';
			if (sgv > 200) return 'rgb(255, 0, 0)';
			return 'rgb(0, 255, 0)';
		}

		var color = Chart.helpers.color;
		var sgvConf = {
			type: 'line',
			data: {
				labels: [// date
				],
				datasets: [{
					label: "Glucose",
					backgroundColor: color(window.chartColors.blue).alpha(0.5).rgbString(),
					borderColor: window.chartColors.blue,
					fill: false,
					data: []
				}]
			},
			options: {
                title:{
                    text: "Chart.js Time Scale"
                },
				scales: {
					xAxes: [{
						type: "time",
						time: {
							format: timeFormat,
							// round: 'day'
							tooltipFormat: 'll HH:mm'
						},
						scaleLabel: {
							display: true,
							labelString: 'Date'
						}
					}, ],
					yAxes: [{
						scaleLabel: {
							display: true,
							labelString: 'mg/dL'
						},
						ticks: {
							suggestedMin: 40,
							suggestedMax: 280,
							stepSize: 40

						}
					}],
				},
				annotation: {
					events: [],
					annotations: [
					{
						drawTime: "beforeDatasetsDraw",
						id: "lowRange",
						type: "box",
						xScaleID: "x-axis-0",
						yScaleID: "y-axis-0",
						yMin: 0,
						yMax: 80,
						xMin: moment("1969-12-31T23:59:59-0500"),
						xMax: moment("2969-12-31T23:59:59-0500"),
						backgroundColor: "rgba(255, 0, 0, 0.1)"
					}, {
						drawTime: "beforeDatasetsDraw",
						id: "highRange",
						type: "box",
						xScaleID: "x-axis-0",
						yScaleID: "y-axis-0",
						yMin: 200,
						yMax: 400,
						xMin: moment("1969-12-31T23:59:59-0500"),
						xMax: moment("2969-12-31T23:59:59-0500"),
						backgroundColor: "rgba(255, 0, 0, 0.1)"
					}, {
						drawTime: "beforeDatasetsDraw",
						id: "goodRange",
						type: "box",
						xScaleID: "x-axis-0",
						yScaleID: "y-axis-0",
						yMin: 80,
						yMax: 200,
						xMin: moment("1969-12-31T23:59:59-0500"),
						xMax: moment("2969-12-31T23:59:59-0500"),
						backgroundColor: "rgba(0, 255, 0, 0.1)",
						borderColor: "rgba(0, 255, 0, 1)",
						borderWidth: 2
					}]
				}

			},
		};

		window.onload = function() {
			var ctx = document.getElementById("canvas").getContext("2d");
			window.sgvChart = new Chart(ctx, sgvConf);


			superagent.get("test-data.json", function(resp) {
				var data = JSON.parse(resp.text);
				console.log(data);
				var ldata = [];
				var dataset = sgvChart.config.data.datasets[0];
				dataset.data = [];
				dataset.pointBackgroundColor = [];
				for (var i in data) {
					var obj = data[i];
					console.log(obj);
					dataset.data.push({
						x: moment(obj['dateString']),
						y: obj['sgv']
					});
					dataset.pointBackgroundColor.push(colorForSgv(obj['sgv']))
				}
				
				console.log(ldata);
				window.sgvChart.update();
			});

		};

		document.getElementById('randomizeData').addEventListener('click', function() {
			config.data.datasets.forEach(function(dataset) {
				dataset.data.forEach(function(dataObj, j) {
					if (typeof dataObj === 'object') {
						dataObj.y = randomScalingFactor();
					} else {
						dataset.data[j] = randomScalingFactor();
					}
				});
			});

			window.myLine.update();
		});

		var colorNames = Object.keys(window.chartColors);
		document.getElementById('addDataset').addEventListener('click', function() {
			var colorName = colorNames[config.data.datasets.length % colorNames.length];
			var newColor = window.chartColors[colorName]
			var newDataset = {
				label: 'Dataset ' + config.data.datasets.length,
				borderColor: newColor,
				backgroundColor: color(newColor).alpha(0.5).rgbString(),
				data: [],
			};

			for (var index = 0; index < config.data.labels.length; ++index) {
				newDataset.data.push(randomScalingFactor());
			}

			config.data.datasets.push(newDataset);
			window.myLine.update();
		});

		document.getElementById('addData').addEventListener('click', function() {
			if (config.data.datasets.length > 0) {
				config.data.labels.push(newDate(config.data.labels.length));

				for (var index = 0; index < config.data.datasets.length; ++index) {
					if (typeof config.data.datasets[index].data[0] === "object") {
						config.data.datasets[index].data.push({
							x: newDate(config.data.datasets[index].data.length),
							y: randomScalingFactor(),
						});
					} else {
						config.data.datasets[index].data.push(randomScalingFactor());
					}
				}

				window.myLine.update();
			}
		});

		document.getElementById('removeDataset').addEventListener('click', function() {
			config.data.datasets.splice(0, 1);
			window.myLine.update();
		});

		document.getElementById('removeData').addEventListener('click', function() {
			config.data.labels.splice(-1, 1); // remove the label first

			config.data.datasets.forEach(function(dataset, datasetIndex) {
				dataset.data.pop();
			});

			window.myLine.update();
		});




	</script>
</body>

</html>
